---
description: GitHub連携に関するAIルール
globs:
alwaysApply: true
---

# GitHub連携に関するAIルール

## 目的
本ドキュメントは、AIがGitHubリポジトリ運用を支援する際の基本ルール・運用手順を明確にし、プロジェクト管理の効率化・品質向上を図ることを目的とする。

## 用語定義
- Issue: タスクや議論、バグ報告などを管理するGitHubの機能
- PR（Pull Request）: コードやドキュメントの変更提案
- ステータス: IssueやPRの進行状況（例: open/closed、進行中、レビュー待ち等）

## 基本原則
- チャットでIssueやPRの作成・編集・コメント依頼があった場合、原則として`gh`コマンド（GitHub CLI）を用いてGitHubと連携する。
- `gh`コマンドが利用できない場合は、セットアップ方法を開発者に案内し、連携実現をサポートする。
- **すべてのコミット**で、コミットメッセージ末尾にIssue番号（`#[番号]`）を必ず付与する。
- **AI（Claude Code）の絶対遵守事項**:
  - コミット実行前に必ずIssue番号の有無をチェックする
  - コミット後に必ず `git log --oneline -1` でIssue番号を検証する
  - Issue番号が不足している場合は即座に `git commit --amend` で修正する
  - この手順の省略・スキップは一切許可されない
- **ラベルを使用しない**。

## 運用手順
1. **必須**: descriptionの編集や、関連ブランチでの開発進行中に内容や状況が変化した場合も、ステータス（open/closed、進行中、レビュー待ち等）の変更をAIが能動的に提案・実行する。
2. **必須**: IssueやPRの管理状況が常に最新状態に保たれるよう維持する。

## 補足
- これらのルールはテンプレートリポジトリの初期設定として記録し、各プロジェクトでの運用時にも参照できるようにする。

## コミット・PRとIssueの連携運用

- コミットコメントは、紐づくIssueが明らかな場合、原則として文末へ改行を設けIssue番号をハッシュタグ（例: #1）で付与すること。
- PRの場合も、紐づくIssueが明らかな場合は、Merge完了をもって当該Issueをクローズする運用を原則とする。

## フォーマット・可読性に関するルール

- コミットメッセージやIssue/PRのdescriptionでは、改行やインデントなどのフォーマットに注意し、可読性を損なわないようにすること。
- とくに箇条書きやセクション分け、Issue番号の記載時は適切な改行・空行を挿入し視認性を高めること。
- 改行コードや空白の不適切な挿入による可読性低下が発生した場合は、速やかに修正し、同様の状態が再発しないよう注意する。

## 改行を含むMarkdown記述時の実行方式

### 基本方針
- **Issue/PRのdescriptionやコメント**で改行を含むMarkdownを記述する際は、**--bodyオプション直接指定方式**を最優先で採用する。
- **--bodyオプションで対応困難な場合**（非常に長い文章、特殊文字が多い場合）は、**printf + パイプ方式**を使用する。
- **コミットメッセージ**では、**HEREDOC方式**を使用する。
- いずれの方式でも差支えがある場合は、**一時ファイル方式**を最終手段として使用する。

### --bodyオプション直接指定方式（最優先）
**実行例:**
```bash
gh issue edit 115 --body "複数行の
Markdown内容を
直接記述"
```

**挙動の特徴:**
- もっともシンプルで直接的な方法
- 一時ファイル不要、パイプ処理も不要

**適用場面:** Issue/PRの編集、短〜中程度の文章

### printf + パイプ方式（第2優先）
**実行例:**
```bash
printf '%s' $'### タイトル\n\n**内容:**\n- 項目1\n- 項目2\n' | gh issue comment 1 --body-file -
```

**挙動の特徴:**
- 1行のコマンドで完結し、実行効率が高い
- `$'...'` 構文により改行文字（\n）を直接記述可能
- パイプ（|）でghコマンドの `--body-file -` オプションに内容を渡す
- 一時ファイルが不要で、ファイルシステムへの書き込みが発生しない

**適用場面:** 通常のIssue/PR操作、短〜中程度の文章

### 一時ファイル方式（バックアップ）
**実行例:**
```bash
printf '%s' $'### タイトル\n\n**内容:**\n- 項目1\n- 項目2\n' > /tmp/content.md
gh issue comment 1 --body-file /tmp/content.md
```

**挙動の特徴:**
- 2ステップ（ファイル作成→gh実行）が必要
- 一時ファイルへの書き込み・読み込みが発生
- 複雑なフォーマットや長文でも確実に処理可能
- 実行環境やシェルの制約に影響されにくい

**適用場面:** printf + パイプ方式で問題が発生した場合、非常に長い文章、特殊文字を含む場合

### AIによる判断基準
1. まず`-body`オプション直接指定方式で実行を試みる
2. 文章が非常に長い、または特殊文字で問題が発生した場合、printf + パイプ方式を試みる
3. それでもエラーや制約で実行不可の場合、一時ファイル方式に自動切り替え
4. いずれの方式も記録し、今後の改善に活用する

## Issue着手前の必須確認

### Issue番号を受け取った際の必須チェック
**Issue番号を受け取って作業を開始する前に、必ず以下を実行すること：**

#### 1. 現在の状況確認（必須）
```bash
# 現在のブランチを確認
git branch --show-current

# 現在の作業ディレクトリの状態を確認
git status
```

#### 2. ブランチ判定と対応
**現在のブランチが `develop` または `main` の場合：**
- 警告: メインブランチで直接作業することは禁止
- 必須対応: 新規作業ブランチを作成

**現在のブランチが作業ブランチの場合：**
- そのまま継続使用可能
- 新規ブランチ作成は不要

#### 3. 新規ブランチ作成（developまたはmainにいる場合）
```bash
# 新しいブランチを作成
git checkout -b feature/[概要]#[Issue番号]
```

#### 4. 作業開始前の最終確認
```bash
# 最終的なブランチ確認
git branch --show-current

# リモートとの同期状態確認
git status
```

### AI（Claude Code）への指示
**Issue番号を受け取った際は、必ず以下の順序で実行すること：**

1. **現在のブランチ確認**: `git branch --show-current`
2. **状態確認**: `git status`
3. **判定**: develop/mainなら新規ブランチ作成、作業ブランチなら継続
4. **必要に応じてブランチ作成**: `git checkout -b feature/[概要]#[Issue番号]`
5. **最終確認**: 作業開始前の状態確認

---

## ブランチ命名ルール

### ブランチ確認の詳細ルール
**上記の「Issue着手前の必須確認」を実行した後の補足情報：**

**ブランチ作成の判定基準：**
- 現在のブランチが `develop` や `main` でない場合は、それを作業ブランチとして使用
- 新規ブランチの作成は避ける
- 現在のブランチが `develop` または `main` の場合のみ新規作成
- 他の開発者と協業する特別な理由がある場合も新規作成

### Issue紐付きブランチの命名規則
- Issueに紐付いた作業ブランチは以下のフォーマットで命名する：
  ```
  feature/[概要]#[Issue番号]
  ```

### 📝 命名規約の厳格化
#### 必須事項
- **英数字のみ使用**：日本語（2バイト文字）は一切使用禁止
- **ハイフン（-）区切り**：単語間はハイフンで区切る
- **小文字使用**：すべて小文字で記述
- **簡潔な英語表記**：概要部分は5単語以内

#### 禁止事項
- 日本語文字の使用（ひらがな、カタカナ、漢字）
- スペースの使用

### 命名例
**正しい例：**
- `feature/initial-setup#1` - 初期セットアップ（Issue #1）
- `feature/user-auth#15` - ユーザー認証機能（Issue #15）
- `feature/api-docs#23` - APIドキュメント整備（Issue #23）

**誤った例：**
- `feature/初期セットアップ-#1` - 日本語使用
- `feature/api docs-#23` - スペース使用

### ブランチ作成・運用手順
#### 1. 現在のブランチ確認（必須）
```bash
# 現在のブランチを確認
git branch --show-current
```

#### 2. 作業ブランチの判定
- **現在のブランチが `develop` や `main` 以外の場合**：
  - そのまま現在のブランチで作業を継続
  - 新規ブランチの作成は不要

- **現在のブランチが `develop` または `main` の場合**：
  - 新規作業ブランチを作成

#### 3. 新規ブランチ作成（必要な場合のみ）
```bash
# 新しいブランチを作成
git checkout -b feature/[英語概要]#[Issue番号]
# 初回コミット
git add .
git commit -m "[動詞]: [変更内容] #[Issue番号]"
# リモートにpush
git push -u origin feature/[英語概要]#[Issue番号]
```

### ブランチとIssueの紐づけ手順
1. **現在のブランチ確認**: `git branch --show-current` で現在の作業ブランチを確認
2. **ブランチ判定**: develop/main以外なら継続使用、develop/mainなら新規作成
3. **初回コミット**: 作業内容をコミット
4. **初回リモートpush**: `git push -u origin [ブランチ名]` でリモートにpush
5. **Issue Development紐づけ**: ブランチ名にIssue番号が含まれるため、GitHubが自動認識してIssueのDevelopmentセクションに反映
6. **作業完了後**: PRを作成してMerge完了でIssue自動クローズ

### 自動紐づけの仕組み
- ブランチ名に `#[Issue番号]` が含まれていると、GitHubがIssueとブランチの関連を自動認識
- 初回リモートpush時にIssueのDevelopmentセクションに「ブランチ」として表示される
- 手動設定が不要で、ブランチpushだけで自動的に紐づけが完了

### AI（Claude Code）の必須確認事項
**重要**: 上記の「Issue着手前の必須確認」を実行した後の補足チェック

1. **ブランチ命名チェック**：
   - 日本語文字が含まれていないかを確認
   - 命名規約にしたがっているかを確認
   - Issue番号が正しく含まれているかを確認

2. **エラー防止策**：
   - 日本語文字が検出された場合は即座に修正提案
   - 規約違反のブランチ名は自動で英語版に変換提案

### コミットメッセージの規則

#### 必須要件
- **すべてのコミット**で、コミットメッセージ末尾に `#[Issue番号]` を付与する
- 例: `Add: 新機能を追加 #8`、`Fix: バグを修正 #8`

#### コミット前チェックリスト
AIは以下を実行前に確認すること：
1. **Issue番号確認**: コミットメッセージ末尾に `#[Issue番号]` が含まれているか
2. **フォーマット確認**: `[動詞]: [内容] #[Issue番号]` の形式になっているか

#### 標準テンプレート（コミットメッセージ用HEREDOC方式）
```bash
git commit -m "$(cat <<'EOF'
[動詞]: [変更内容の概要]

- [詳細1]
- [詳細2]
- [詳細3]

#[Issue番号]
EOF
)"
```

または、より簡潔な場合：
```bash
git commit -m "[動詞]: [変更内容の概要] #[Issue番号]"
```

#### 強制的なエラー防止策

##### 1. コミット実行前の必須チェック
AIは以下の手順を**必ず実行**すること：
```bash
# Step 1: コミットメッセージの事前確認
echo "コミットメッセージ: [実際のメッセージ] #[Issue番号]"
# Step 2: Issue番号の存在確認
[コミットメッセージに #[Issue番号] が含まれているかを目視確認]
# Step 3: 確認後にコミット実行
```

##### 2. コミット後の即座検証
```bash
# コミット直後に必ず実行
git log --oneline -1
# Issue番号が含まれていない場合は即座にamend
```

##### 3. 三重チェック体制
1. **事前チェック**: コミットメッセージ作成時に #[Issue番号］を必ず含める
2. **実行時チェック**: コミット前に必ずメッセージ内容を確認
3. **事後チェック**: コミット後に `git log --oneline -1` で検証

##### 4. 失敗時の即座修正プロトコル
Issue番号が不足している場合：
```bash
# 即座にamendで修正
git commit --amend -m "$(cat <<'EOF'
[元のコミットメッセージ]

#[Issue番号]
EOF
)"
# 修正後に再度検証
git log --oneline -1
```

##### 5. 根本的改善策
- **AIの注意力に依存しない仕組み**: 機械的なチェックを導入
- **テンプレート強制使用**: 自由記述を避け、テンプレート必須化
- **段階的確認**: コミット前・中・後の三段階チェック