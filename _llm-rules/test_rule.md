---
description: Test rule
globs: *.spec.ts, *.test.ts
alwaysApply: false
---

# AIタスク実行のためのテスト作成ガイドライン

あなたは高度な問題解決能力を持つAIアシスタントです。このプロジェクトのテストを作成する際は、以下のガイドラインに従ってください。

## 重要：プロジェクト固有のテスト仕様書の参照

具体的なテスト実装方法、テストユーティリティ、パターンについては、[プロジェクト要件定義](../_llm-docs/requirements_definition.md)から参照してください。

**注意**: 各プロジェクトでは、サイトやモジュールごとに個別のテスト仕様書が用意されている場合があります。必ずプロジェクトのドキュメントを確認してください。

## テストの基本原則

- ユーティリティ関数とHooksのユニットテストを作成する
- コンポーネントの単体テストと統合テストを実装する
- 外部依存を避けるためモックデータを使用する
- 現在の開発段階ではE2Eテストは実装しない

## テスト作成の原則

### 一般的なガイドライン

- 保守性、可読性、信頼性の高いテストを作成する
- AAAパターン（準備・実行・検証）に従う
- 期待される動作を説明する意味のあるテスト説明を使用する
- テストは独立性と分離性を保つ
- テスト間の依存関係を避ける
- テストダブル（モック、スタブ、スパイ）を適切に使用する

### ユニットテスト

- テスト対象のソースファイルと同じ場所にユニットテストを配置する
- コンポーネント/ユーティリティディレクトリ内で`.test.tsx`ファイルを作成する（例：`Button.test.tsx`）
- ビジネスロジックとコンポーネントの動作に焦点を当てる
- 成功ケースとエラーケースの両方をテストする
- テストファイルは小さく焦点を絞る
- 実際のシナリオを表す意味のあるテストデータを使用する

### 統合テスト

- テストする機能の近くに統合テストを配置する
- コンポーネントの相互作用とデータフローに焦点を当てる
- 現実的なテストデータとシナリオを使用する
- 外部依存関係を適切にモックする
- エラー処理とエッジケースをテストする

### E2Eテスト

**現在の開発段階では実装しない**

- プロジェクトが成熟した段階でE2Eテストの導入を検討
- 現在は単体テストと統合テストに集中
- MSWを使用したAPIモックで十分なテストカバレッジを確保

## ベストプラクティス

### テストデータ管理

- 共通のテストデータにはフィクスチャを使用する
- テストデータ生成のためのデータファクトリを実装する
- テストデータは現実的だが最小限に保つ
- テスト完了後はテストデータをクリーンアップする

### テストの優先順位

**現在の開発段階での優先順位：**

1. **ユニットテスト** - コンポーネント、カスタムフック、ユーティリティ関数
2. **統合テスト** - Redux統合、API連携（MSWでモック）
3. **E2Eテスト** - 将来の実装予定（現在は対象外）

### テスト範囲の指針

**テストすべきもの：**

- カスタムフックのロジック
- 状態管理（Redux連携）
- APIレスポンスの処理（MSWでモック）
- エラーハンドリング

**テストしないもの：**

- 外部APIの実際の通信
- E2Eのユーザーフロー
- ブラウザ間の互換性
- パフォーマンステスト
- **UI（画面表示要素）のコンポーネントテスト** - React コンポーネントの表示・レンダリングテストは不要

## テスト作成の判断基準

以下の基準に従い、ロジックの期待通りの挙動を検証するテストを中心に提案してください。
表面的なUI動作や単純な表示確認は、重要性が低いためテスト対象外とします。

### テスト対象の基本方針

**テストすべきもの（ロジック中心）:**

- 入力に対する出力が期待通りであること
- 条件分岐による処理の違い
- エラーハンドリングの動作
- 状態変化による副作用
- データ変換・計算処理の正確性
- ビジネスルールの実装

**テストすべきもの（ロジックの結果確認）:**

- エラーメッセージの内容が正しく生成されているか
- APIエラー時の適切なフィードバック表示
- バリデーション結果に基づく状態変化
- 重要な状態変更がUIに反映されているか

**テストしないもの（基礎的なUI・表面的動作）:**

- 単純なボタンクリックイベントの発火
- コンポーネントの基本的な初期表示
- スタイルやレイアウトの確認
- 単純なpropsの受け渡し
- ログ出力や console.log の動作
- 単純な値の代入や取得
- **Reactコンポーネント（.tsx）のレンダリングテスト** - UI表示確認は不要、ビジネスロジック（.ts）のテストのみ実装

### 1. API疎通ロジックのテスト

**テスト推奨ケース:**

- APIレスポンスデータの変換・加工が正しく行われる
- エラーレスポンス時の適切なエラー状態管理
- エラー時のエラーメッセージ内容が適切である
- ページネーション計算ロジック（次ページ有無、総ページ数等）
- リトライ処理やタイムアウト処理
- データキャッシュの制御ロジック

**テストしないもの:**

- APIが呼び出されること自体の確認
- ローディングスピナーの表示/非表示（単純な状態切り替え）
- 取得データの単純な表示確認

### 2. フォームロジックのテスト

**テスト推奨ケース:**

- バリデーション関数の判定結果（入力値に対する true/false等）
- バリデーションエラー時の適切なエラーメッセージ生成
- 送信可能状態の判定ロジック（バリデーション結果に基づく）
- 入力値の正規化・変換処理
- フォーム状態の更新ロジック
- エラー状態に応じた適切なフィードバック内容

**テストしないもの:**

- 入力フィールドへの単純な値の反映
- フォーカス・ブラー等の基本的なイベント

### 3. 認証ロジックのテスト

**テスト推奨ケース:**

- 認証状態の判定処理（トークンの有効性チェック等）
- 権限レベルの計算・判定
- ログイン処理のロジック（認証情報の検証等）
- セッション管理のロジック
- 認証エラー時の適切なエラーメッセージ生成
- 未認証時のアクセス制御ロジック

**テストしないもの:**

- ログインボタンの単純なクリック処理
- リダイレクト処理の実行（ロジックの結果は確認）

### 4. パラメータ・状態依存ロジックのテスト

**テスト推奨ケース:**

- パラメータ値による処理分岐の結果
- 状態変化時の副作用処理の実行内容
- 条件に応じたデータ変換の正確性
- 複雑な計算処理の結果
- パラメータ不正時のエラーハンドリング

**テストしないもの:**

- パラメータによる単純な表示内容の切り替え
- 状態変化による再レンダリング自体
- 単純な条件による表示/非表示の切り替え

### 5. 汎用関数のテスト

**テスト推奨ケース:**

- 関数の入力と出力の関係
- エッジケースでの動作
- エラー条件での例外処理
- 複雑なアルゴリズムの実装
- 正常系・異常系の両方のケース

**テストしないもの:**

- 関数が呼び出されること自体
- 関数の戻り値が使用されること

### ロジックテストの判定基準

**テスト提案する条件:**

1. **複雑な条件分岐がある** - if/else、switch文で複数パターンの処理がある
2. **計算・変換処理がある** - データの加工、数値計算、文字列操作等
3. **エラーハンドリングがある** - try/catch、エラー状態の管理
4. **ビジネスルールの実装がある** - 業務固有の判定・処理ロジック
5. **副作用を伴う処理がある** - API呼び出し、ストレージ操作等
6. **複数の状態や引数に依存する処理がある** - 組み合わせによって結果が変わる

**テスト提案しない条件:**

1. **単純な値の取得・設定のみ** - getter/setter的な処理
2. **イベントハンドラーの登録のみ** - onClick等の単純なイベント処理
3. **表示・非表示の切り替えのみ** - UI状態の変更のみ
4. **単純なpropsの受け渡しのみ** - データの橋渡し処理のみ

## 実装の詳細

テストコードを実装する際は、必ず[プロジェクト要件定義](../_llm-docs/requirements_definition.md)からテスト仕様を参照してください。
一般的に、プロジェクトのテスト仕様書には以下の情報が含まれています：

- テスト環境のセットアップ方法
- 利用可能なテストユーティリティ
- モックライブラリの設定とパターン
- 具体的なテストコードの例
- トラブルシューティング
