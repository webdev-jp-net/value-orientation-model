---
description: Implementation principle
globs:
alwaysApply: true
---

# 実装原則ガイドライン

## 実装前の調査と準備

### 既存コードの変更原則

- 正常に動作している既存コードは変更しない
- 要件に直接関係ない部分の修正は禁止
- リファクタリングは明示的な指示がある場合のみ実施
- 既存機能への影響を最小限に抑える

### 影響範囲の特定

- 変更が他のモジュールに与える影響を把握
- 互換性を保つ方法を検討
- 段階的な実装計画を立案

### 技術要件の確認

- 必要なライブラリがプロジェクトに含まれているか確認
- 新しい依存関係の追加は事前承認を求める
- 実装方針を明確化し、複数選択肢は比較検討

## エラーハンドリング

### エラー処理の実装

- 想定エラーケースを網羅的に特定

### エラー処理フローの実装パターン

- エラーハンドリングの基本構造
  - メイン処理: 通常の処理を実行
  - エラー捕捉: 発生したエラーを分類し適切に処理
  - クリーンアップ: リソースの解放や後処理を確実に実行
- エラー分類と対応
  - 一時的エラー: リトライ処理を実行
  - 永続的エラー: エラーログ記録し、ユーザーへ通知
  - 予期しないエラー: 詳細ログ記録し、汎用エラーメッセージ表示
- 処理フローの例
  - 入力検証 → 前処理 → メイン処理 → 後処理 → 結果返却

### エラーメッセージの基準

- メッセージに含めるべき要素
  - 何が起きたか: 「ログインに失敗しました」
  - なぜ起きたか: 「メールアドレスまたはパスワードが正しくありません」
  - どうすればよいか: 「入力内容を確認して再度お試しください」
- 避けるべきメッセージ
  - 技術的すぎる: 「NullPointerException」
  - 曖昧すぎる: 「エラーが発生しました」
  - 情報不足: 「失敗」

### ログ出力の実装

- 運用監視に必要な情報を記録

## 非同期処理とパフォーマンス

### 処理効率の最適化

- 並列実行可能な処理を特定し実装
- 不要な待機時間や計算処理を削減

## セキュリティ実装

### 入力値の検証と処理

- 全外部入力にバリデーションを実装
- 入力値のサニタイゼーションを実行
- SQLインジェクション・XSS攻撃を防ぐ処理を実装

**重要**: 固定文字列のエラーメッセージにはescapeHtml不要
- 開発者定義の固定エラーメッセージ（例：'リンクが無効です'）はサニタイズ不要
- APIレスポンス・ユーザー入力など外部からの動的な値のみescapeHtml使用
- 過剰なセキュリティ対策は避け、適切な場面でのみ実装すること

### 機密情報の管理

- APIキー・パスワードを環境変数で管理
- 機密情報のログ・レスポンス出力を回避

### セキュリティ設定

- CORS設定を適切に実装
- セキュリティヘッダーを適切に設定

## 実装の優先順位

### 技術的判断の優先順位

1. セキュリティ - 脆弱性対策を最優先
2. パフォーマンス - 処理速度とリソース効率
3. 可読性 - コードの理解しやすさと保守性

## 実装時の命名規則と構造

### コードの可読性

- 変数・関数・クラス名は意味を明確に
- 略語や省略形を避け、完全な単語を使用
- 助動詞を使った説明的な変数名を使用する（例：isLoading、hasError）
- 条件文では不要な中括弧を避け、単純な文には簡潔な構文を使用する

### ファイル構造とモジュール化

- 関連機能を同じモジュールにまとめる
- 設定値・定数を適切な場所で定義・管理

## コードの統一性確保

### 既存コードパターンの踏襲

- 既存コードの変更原則（実装前の調査と準備を参照）に従う
- 新規実装時は周辺コードのスタイルを踏襲
- プロジェクト固有の慣習を優先

### 一貫性の原則

- 同一ファイル内では必ず同じスタイルを維持
- 同一機能内では命名規則を統一
- 既存のデータ構造やエラー形式を再利用

## コメントとドキュメント

### コメントの原則

- 複雑なビジネスロジックにはコメント追加
- 短い説明にはシングルラインコメント`//`を、詳細な説明にはブロックコメント`/* ... */`を使用する

## 実装完了時の確認事項

### コードクリーンアップ

- 不要なコメント・デバッグ用コードを削除
- 未使用のimport文・ライブラリを削除
- フォーマッター・リンターエラーを解消

### 要件との照合

- 実装内容が元の要件を満たすか確認
- 技術的判断の優先順位（実装の優先順位を参照）に基づき検証

### テストコードの必要性確認

- 実装完了時は`_llm-rules/test_rule.md`を参照し、テストコードが必要かどうかを判断する
- 必要と判断された場合は、テストコードの作成を提案する

---

これらの原則により、保守性・安全性・効率性の高いコードを作成できます。
